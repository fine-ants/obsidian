
### 문제점
현재 백엔드 서버는 장 시간동안에 포트폴리오의 종목 및 종목 지정가에 등록된 종목들을 조회한 다음에 종목들을 대상으로 한국투자증권 서버를 통하여 현재가를 조회한 다음에 현재가를 레디스에 저장하는 방식으로 수행하고 있습니다. 만약에 현재가 또는 종가 조회시 레디스에 가격이 존재하지 않는다면 한국투자증권에 조회하여 저장 및 반환하는 방식을 수행하고 있습니다. 

문제점은 무엇인가?
- 클라이언트에서 종목의 현재가 또는 종가와 관련된 API 요청시 최대한의 지연없이 빠르게 가격을 포함한 정보를 응답하는 것
- 무언가 지금 시스템은 종목을 갱신할때 정작 사용하지 않는 종목들을 갱신하고 있음. 포트폴리오 종목에 등록된 종목들을 우선적으로 갱신하고 있는데, 이는 사용자가 포트폴리오 종목들에 관심이 있기 때문에 미리 갱신을 해두었다가 빠르게 제공하기 위해서임
- 2800개 여개의 종목들이 있는데 이 종목들을 각각 한국투자증권 서버에 요청하여 현재가를 받아오는데 2분 30초정도 걸린다.
- 클라이언트가 종목에 대한 정보(현재가 등) 조회시 서버(Redis, DB)에서 가지고 있지 않은 정보인 경우 한국투자증권 서버에 조회하여 가져와야 하는데 타이밍이 좋지 않아서 요청 건수 초과로 시간이 꽤 걸릴수도 있음.

### 개선 방향
- 포트폴리오에 포함된 종목을 우선적으로 갱신하고, 나머지 종목들은 덜 빈번하게 갱신하는 동적 스케줄링 방식을 고려. 이렇게 함으로써 우선순위가 높은 종목에 대한 가격 정보는 빠르게 갱신함
- Redis에서 각 종목의 갱신 시간을 기록하고, 가격 변화가 적거나 거래량이 낮은 종목은 갱신 주기를 늘린다. 모든 종목을 동일한 주기로 갱신하는 대신에 실시간으로 변동이 큰 종목에 우선순위를 두어서 효율을 높이는 방식



### 한국투자증권 에러 응답
초당 거래 건수 초과
![[Pasted image 20240823143916.png]]

액세스 토큰 발급 에러
![[Pasted image 20240823144246.png]]

기간 만료 토큰
![[Pasted image 20240823150806.png]]

## AccessToken Check AOP 문제
- 문제점 : @CheckKisAccessToken 애노테이션이 달린 메서드를 비동기적으로 실행한다. 그러나 액세스 토큰 만료시 AOP에서 재발급할때 block되는 문제가 발생함
- 해결방법 : 각각의 메서드가 AOP를 통해서 재발급받는 것이 아닌 AccessTokenRepository가 주기적으로 액세스 토큰을 체크한 다음에 자동적으로 재발급하는 방법이 어떤가 생각됨.