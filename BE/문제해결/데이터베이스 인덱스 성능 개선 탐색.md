
## 목표
Spring JPA + MySQL 환경에서 성능 개선이 필요한 테이블이나 쿼리를 찾아서 성능 개선을 수행합니다.

## 1. 느린 쿼리 로그 활성화(slow_query_log)
먼저 MySQL에서 실제로 느리게 실행되는 쿼리를 수집하기 위해서 slow_query_log를 설정합니다.
```sql
-- 느린 쿼리 로그 활성화
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1; -- 1초 넘는 쿼리만 수집
SET GLOBAL log_queries_not_using_indexes = 'ON'; -- 인덱스를 사용하지 않은 쿼리도 수집

```

로그 파일 위치 확인
```sql
SHOW VARIABLES LIKE 'slow_query_log_file';
```
![[Pasted image 20250412131322.png]]
실행 결과를 보면 /var/lib/mysql 디렉토리에 로그가 저장되는 것을 확인할 수 있습니다. 수집된 쿼리들은 mysql.show_log 테이블 또는 로그 파일에서 볼수 있고, 이것을 기준으로 분석합니다.

## 2. 애플리케이션 로그 + APM으로 병목 찾기
JPA를 사용하는 경우, 다음 두가지도 활용해 병목 쿼리를 찾을 수 있습니다.
(1) JPA SQL 로그 분석
`application.yml`에 다음 설정을 넣으면 JPA 쿼리를 콘솔로 확이할 수 있습니다.
```yaml
spring:
	jpa:  
	  properties:  
	    hibernate:  
	      format_sql: true  
	  show-sql: true
```
쿼리를 살펴보다가 JOIN이 너무 많은 쿼리, LIMIT 없이 대량 SELECT, WHERE 조건 없는 JPQL