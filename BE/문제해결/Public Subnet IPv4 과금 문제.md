
## 배경
2024-12월에 대한 청구서를 확인하였는데 예상치 못한 5.43$ 과금이 발생하였습니다.
![[Pasted image 20250102140910.png]]

## 원인
- 12월에 로드 밸런서 ALB 추가하게 되었습니다. 그러나 ALB 추가시 public subnet을 최소 2개를 요구하게 됩니다.
- 기존 프리티어 사용시에는 public subnet을 1개만 사용하였고 public IPv4에 대해서 750시간을 지원하여 과금이 발생하지 않았지만 추가적인 public subnet 발생으로 인해서 추가적인 IPv4을 사용하게 되었습니다.

## 해결 방법
- public subnet 2개를 IPv4를 할당하지 않고 IPv6으로 할당하도록 변경합니다.
- ALB을 IP 주소 유형을 퍼블릭 IPv4가 없는 듀얼 스택으로 다시 생성합니다.


### VPC 새로운 IPv6 CIDR 추가
1. VPC 서비스의 VPC 페이지로 이동합니다.
![[Pasted image 20250102141905.png]]

2. IPv6 CIDR를 추가할 VPC를 선택한 다음에 작업->CIDR 편집 버튼을 클릭합니다.
![[Pasted image 20250102141939.png]]

3. CIDR 편집 페이지에서 새 IPv6 CIDR 추가 버튼을 클릭하여 새로운 IPv6 CIDR을 추가합니다. 추가한 다음에 닫기 버튼을 클릭합니다.
![[Pasted image 20250102150050.png]]


### Public Subnet IPv6 할당
1. VPC 서비스의 서브넷 페이지로 이동합니다.
![[Pasted image 20250102141627.png]]

2. Public Subnet 한개를 선택한 다음에 작업->IPv6 CIDR 편집 버튼을 클릭하여 이동합니다.
![[Pasted image 20250102141734.png]]

3. IPv6 CIDR 추가 버튼을 클릭한 다음에 다음과 같이 /64로 설정합니다.
![[Pasted image 20250102143441.png]]
- VPC의 CIDR 블록이 1234:4567:7890:1234::/56인 경우에는 앞에서부터 56비트를 고정하기 때문에 1234:4567:7890:12까지 고정됩니다. 서브넷의 CIDR블록을 /64로 설정하게 되면 8bit를 추가 고정할 수 있습니다. 예를 들어 1234:4567:7890:1200::/64로 설정하게 되면 해당 서브넷은 1234:4567:7890:1200:0:0:0:0 ~ 1234:4567:7890:1200:ffff:ffff:ffff:ffff 까지 범위가 잡힙니다.
- public subnet 2개의 IPv6 CIDR을 다음과 같이 설정합니다.
	- public subnet 1 : 1234:4567:7890:1200::/64
	- public subnet 2 : 1234:4567:7890:1201::/64

4. IPv6 CIDR 블록 생성 확인합니다. 
![[Pasted image 20250102142115.png]]

5. 2~4번 과정을 public subnet1, public subnet2를 대상으로 수행합니다.


### 기존 ALB의 로드 밸런서 IP 주소 유형 수정
1. 특정 로드 밸런서를 선택한 다음에 작업 -> IP 주소 유형 편집 버튼을 클릭합니다.
![[Pasted image 20250102152042.png]]

2. 로드 밸런서 IP 주소 유형에서 "듀얼 스택" 옵션을 선택합니다.
![[Pasted image 20250102161708.png]]
- 듀얼 스택
	- 해당 로드밸런서에 IPv4와 IPv6 주소가 할당되어 IPv4와 IPv6 클라이언트 모두에서 접근이 가능합니다.
- 퍼블릭 IPv4가 없는 듀얼 스택
	- 해당 옵션은 퍼블릭 IPv6 주소만 할당되기 때문에 IPv4 클라이언트는 접근이 불가능합니다.
	- 로드 밸런서 내부의 EC2 인스턴스와의 통신은 여전히 IPv4를 사용할 수 있습니다. 이때 IPv6 트래픽은 내부에서 IPv4로 변환되어 전달됩니다.

### 서브넷의 IPv4 할당 해제
1. VPC 서비스의 특정 서브넷을 선택한 다음에 작업->서브넷 설정 편집 버튼을 클릭합니다.
![[Pasted image 20250102152526.png]]

2. 다음과 같이 자동 할당 IP 설정에서 IPv6 주소만 할당하도록 설정을 변경합니다.
![[Pasted image 20250102152556.png]]

3. DNS64 설정을 활성화시킵니다.
![[Pasted image 20250102162206.png]]
- DNS64는 VPC에서 IPv6 클라이언트가 IPv4-only 서버에 접근할 수 있도록 도와주는 **DNS 변환 서비스**

4. . 다른 public subnet을 대상으로도 IPv6 주소 자동 할당을 활성합니다.

### Route53 AAAA 레코드 추가
기존 A레코드만 있는 상태에서 IPv6 클라이언트를 처리할 AAAA 레코드를 추가합니다.

1. Route53 서비스 -> 호스팅 영역 -> 등록된 호스팅 선택
![[Pasted image 20250102153059.png]]

2. 다음과 같이 레코드를 추가합니다.
![[Pasted image 20250102153220.png]]

### 보안 그룹 수정
1. EC2 -> 보안 그룹 -> 특정 보안 그룹 선택한 다음에 IPv6 클라이언트의 요청을 처리할 인바운드 규칙을 다음과 같이 편집합니다.
![[Pasted image 20250102162450.png]]
