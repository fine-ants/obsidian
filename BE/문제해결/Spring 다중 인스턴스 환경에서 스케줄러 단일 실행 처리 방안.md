
## 배경
- Spring 서버가 스케일 아웃하면서 동시 실행하는 구조가 되면서 각 인스턴스에 등록된 `@Scheduled` 작업이 중복 실행되는 문제가 발생할 수 있습니다.
- 예를 들어 5초마다 종목의 현재가를 갱신하는 스케줄러 작업같은 경우 중복 실행할 필요가 없습니다.

### 문제정의
- 다중 인스턴스 환경에서 `@Scheduled` 메서드가 모든 인스턴스에서 실행됩니다.
- 한번만 실행되어야 할 작업이 중복 실행됩니다.
- 리소스 낭비, 장애 유발, API 호출 제한 등이 유발됩니다.

### 해결 방안 제안
1. Redis 기반 분산 락
2. ShedLock 라이브러리 활용
3. 특정 인스턴스 전용 프로파일로 실행

| 구분          | Redis 기반 분산 락                                                                                                                                          | ShedLock 라이브러리 활용                                                                                   | 특정 인스턴스 전용 프로파일로 실행                                                                                                                               |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| 장점          | - 쉽고 실용적<br>- 이미 Redis를 사용하는 환경에 적합                                                                                                                    | - 설정이 간단하고 Spring 환경에 최적화되어 있습니다.  <br>- 저장소(RDB, Redis, Mongo 등)에 유연성을 가짐                          | - 설정이 간단<br>- 안정성이 높음                                                                                                                             |
| 단점         | - Redis 장애시 전체 시스템에 영향이 간다<br>- 네트워크 지연에 민감. 클러스터 환경에서 Redis와의 통신 지연이 문제 될 수 있음<br>- TTL 설정 실수 시 데드락 또는 중복 실행 발생 가능성이 있음<br>- Redisson 사용시 복잡한 설정이 필요함 | - 락 갱신 주기에 민감함<br>- DB에 락 테이블이 필요함<br>- 모든 Job에 명시적으로 애노테이션 추가 필요함<br>- 스케줄러 간 충돌 방지용 버퍼 설정 고려가 필요함 | - 자동 failover 불가능<br>- 수동 관리 필요함. 배포 시 해당 인스턴스 구분 및 설정이 필요함<br>- 스케줄러 인스턴스가 중복 배포될 경우 제어 불가능함<br>- 배포 관리자 실수로 여러 인스턴스가 `schduler` 프로파일을 가질 위험이 있음 |
| 핵심 기술       | Redis(setnx, Redisson)                                                                                                                                 | DB/Redis/Mongo                                                                                      | Spring Profile                                                                                                                                    |
| 락 있음        | O                                                                                                                                                      | O                                                                                                   | X                                                                                                                                                 |
| 자동 failover | O                                                                                                                                                      | O                                                                                                   | X                                                                                                                                                 |
| 적합 환경       | Redis 운영중인 환경                                                                                                                                          | 간단한 분산 환경                                                                                           | 단순 운영 환경                                                                                                                                          |

## 선택한 전략 : ShedLock 라이브러리 활용
### 선택 이유
- 현재 서버 아키텍처 구조가 Spring 서버와 Redis를 사용하고 있습니다.
- ShedLock 라이브러리가 Redis 저장소를 지원합니다.
- 특정 인스턴스 전용 프로파일로 실행하는 방법은 자동 failover가 불가능하고, 수동 관리가 필요하기 때문에 선택하지 않았습니다.
- Redis 기반 분산 락 방법 대신 선택한 이유
	- ShedLock 라이브러리가 상대적으로 구현 난이도가 간단합니다. 반면 Redis 기반 분산 락 방법은 직접 락을 구현해야 하거나 Redisson에 의존해야 합니다.
	- Spring 통합성 부분이 ShedLock 라이브러리가 더 높기 때문입니다. ShedLock 라이브러리 사용시 `spring Schedule + @Scheduler + @EnableScheduling` 조합으로 바로 사용이 가능합니다. 반면 Redis 기반 분산 락 방법은 별도 락 흭득 로직이 필요합니다.
	- ShedLock 라이브러리를 활용하면 Redis만이 아닌 다른 RDB(MySQL, MongoDB)로 변경하기 쉽습니다. 또한 RDB 기반일 경우 트랜잭션 처리 연계가 가능합니다.
	- ShedLock 라이브러리는 스케줄러 락 전용 라이브러리이지만 Redis 기반 분산 락 방법은 범용 분산 락이기 때문에 부가적인 설정이 필요합니다.


