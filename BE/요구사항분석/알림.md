## 목차
- [[#알림 API|알림 API]]
	- [[#알림 API#토큰 저장|토큰 저장]]
	- [[#알림 API#포트폴리오 목표 수익률 도달 알림 설정|포트폴리오 목표 수익률 도달 알림 설정]]
	- [[#알림 API#포트폴리오 최대 손실율 도달 알림 설정|포트폴리오 최대 손실율 도달 알림 설정]]
	- [[#알림 API#종목 지정가 알림 추가|종목 지정가 알림 추가]]
	- [[#알림 API#종목 지정가 알림 목록 조회|종목 지정가 알림 목록 조회]]
	- [[#알림 API#종목 지정가 알림 제거|종목 지정가 알림 제거]]
	- [[#알림 API#종목 지정가 알림 설정 수정|종목 지정가 알림 설정 수정]]
	- [[#알림 API#활성 알림 목록 조회|활성 알림 목록 조회]]
	- [[#알림 API#회원 알림 목록 조회|회원 알림 목록 조회]]
	- [[#알림 API#회원 알림 모두 읽음|회원 알림 모두 읽음]]
	- [[#알림 API#회원 특정 알림 읽음|회원 특정 알림 읽음]]
	- [[#알림 API#회원 알림 단일 삭제|회원 알림 단일 삭제]]
	- [[#알림 API#회원 알림 전체 삭제|회원 알림 전체 삭제]]
	- [[#알림 API#회원 알림 설정 수정|회원 알림 설정 수정]]
	- [[#알림 API#종목 지정가 알림 발송|종목 지정가 알림 발송]]
- [[#백엔드 내부 서비스|백엔드 내부 서비스]]
	- [[#백엔드 내부 서비스#클라이언트에게 푸시 알림(Push Notification) 전송|클라이언트에게 푸시 알림(Push Notification) 전송]]
	- [[#백엔드 내부 서비스#FCM 토큰 관리|FCM 토큰 관리]]

## 알림 API
### 토큰 저장
- 클라이언트는 FCM 서버로부터 발급받은 토큰을 백엔드 서버에 저장을 요청합니다.
- 서버에 토큰 저장시 유효하지 않은 토큰을 등록하는 경우 에러 응답을 받습니다.

토큰 저장 입력 정보
- FCM 발급 받은 토큰

### 포트폴리오 목표 수익률 도달 알림 설정
- 사용자는 특정한 포트폴리오의 목표 수익 알림 설정을 할 수 있습니다.

### 포트폴리오 최대 손실율 도달 알림 설정
- 사용자는 특정한 포트폴리오의 최대 손실 알림 설정을 할 수 있습니다.

### 종목 지정가 알림 추가
- 사용자는 알림을 받을 특정한 종목의 지정가를 추가할 수 있습니다. 
- 사용자는 종목당 최대 5개까지의 지정가 알림을 추가할 수 있습니다.
- 사용자는 종목에 이미  존재하는 지정가를 추가할 수 없습니다 
- 종목의 지정가는 음수일 수 없습니다.
- 지정가 알림 추가 입력 정보
	- 지정가 가격

### 종목 지정가 알림 목록 조회
- 사용자는 종목들에 대한 지정가 알림 목록을 조회합니다
- 각 종목의 지정가는 오름차순으로 정렬되어야 합니다.

### 종목 지정가 알림 제거
- 사용자는 알림을 받을 특정한 종목의 지정가를 삭제할 수 있습니다.

### 종목 지정가 알림 설정 수정
- 사용자는 특정 종목에 지정된 알림 설정을 수정할 수 있습니다.
- 입력 정보
	- true/false

![[Pasted image 20240202130744.png]]

### 활성 알림 목록 조회
- 사용자는 활성 알림 페이지에 접속시 종목 및 포트폴리오에 설정된 알림 목록을 볼 수 있어야 합니다.
- 종목 및 포트폴리오는 최근 업데이트된 순서대로 정렬합니다.

활성 알림 목록 조회 응답 정보
- 종목
	- 회사명
	- 지정가 알림 등록번호
	- 지정가 금액
- 포트폴리오
	- 포트폴리오 등록번호
	- 이름
	- 목표 수익률 알림 활성화 설정
		- true/false
	- 최대 손실율 알림 활성화 설정
		- true/false

### 회원 알림 목록 조회
- 사용자는 웹 애플리케이션을 실행하면서 그동안 온 알림들을 조회합니다.
- **알림 조회시 읽지 않은 알림들과 읽었지만 삭제하지 않은 알림들을 조회**합니다.
- 정렬 기준 : 최근에 온 알림 메시지가 제일 앞에 위치해야 함

### 회원 알림 모두 읽음
- 사용자는 알림 메시지들을 모두 읽을 수 있습니다.
- 클라이언트는 알람 모두 읽음 처리를 위해서 서버로 알림의 등록번호 리스트를 전달하며 읽음 처리를 요청합니다.
- 서버는 알림 등록번호 리스트를 받아서 해당하는 알림들을 읽음 처리합니다.

### 회원 특정 알림 읽음
- 사용자는 특정한 알림을 읽을 수 있습니다.
- 클라이언트는 알림 읽음 처리를 위해서 서버로 알림의 등록번호를 전달하며 읽음 처리를 요청합니다.
- 서버는 알림 등록번호를 받아서 해당하는 알림을 읽음 처리합니다.

### 회원 알림 단일 삭제
- 사용자는 특정한 알림을 선택하고 지우기를 할 수 있습니다.

### 회원 알림 전체 삭제
- 사용자는 알림 메시지들을 모두 지울 수 있습니다.

### 회원 알림 설정 수정
사용자는 클라이언트 애플리케이션의 데스크탑 설정 및 사용자 알림 설정을 수정할 수 있습니다.
- 브라우저로부터 데스크탑 알림 받기는 사용자가 애플리케이션으로부터 브라우저 알림을 받을 것인지 설정하는 옵션입니다.
	- 기본값 : false
- 포트폴리오 목표 수익률 도달 알림 설정은 사용자가 애플리케이션으로부터 각각의 포트폴리오에 설정된 목표 수익률 도달 알림을 받을 것인지 설정하는 옵션입니다.
	- 기본값 : true
	- 해당 옵션이 false이면 각 포트폴리오의 목표 수익률 도달 알림이 true여도 알림을 받지 않습니다. 즉, 전체 포트폴리오의 목표 수익률 도달 알림을 받지 않겠다는 것을 의미합니다.
- 포트폴리오 최대 손실율 도달 알림 설정은 사용자가 애플리케이션으로부터 각각의 포트폴리오에 설정된 최대 손실율 도달 알림을 받을 것인지 설정하는 옵션입니다.
	- 기본값 : true
	- 해당 옵션도 false이면 목표 수익율 도달 알림 설정과 동일합니다.
- 종목 지정가 알림 설정은 사용자가 애플리케이션으로부터 특정한 종목이 특정한 가격에 도달했음을 알려주는 설정입니다.
	- 기본값 : true
	- 해당 옵션이 false이면 특정한 종목 지정가 알림이 활성화되어 있어도 전부 알림을 받지 않습니다.
- 해당 알림 설정이 false로 변경되어도 각 포트폴리오 및 지정가에 설정된 상세 알림 설정은 변경되지 않는다. 예를 들어 포트폴리오의 목표 수익률 도달 알림 설정이 false로 변경되어도 각 특정한 포트폴리오에 설정된 목표 수익율 도달 알림은 false로 변경되지 않는다.
![[Pasted image 20240131153924.png]]
- 알림 설정에서 4가지 설정(브라우저, 포트폴리오 목표 수익률, 최대 손실율, 종목 지정가 알림)이 전부 비활성화로 변경한 다음에 저장을 한다면 서버의 FCM 토큰은 제거되어야 합니다.
	- 별도의 fcmTokenId가 전송됩니다.

---

### 종목 지정가 알림 발송
- 사용자는 종목의 현재가가 사용자가 지정한 종목의 지정가에 도달하게 되면 푸시 알림을 받아야 합니다.
- 알림 정책
	- 사용자는 종목 특정 지정가 푸시 알림을 받게 되면 해당 특정 지정가는 1시간 이후에 다시 받을 수 있습니다.
		- 예를 들어 삼성전자 종목에 대하여 60,000원을 설정하였습니다. 삼성전자의 현재가가 60,000원에 도달하면 사용자에게 푸시 알림을 전송합니다. 그후 1시간 동안에는 현재가가 60,000원에 도달하여도 푸시 알림을 보내지 않고 푸시 알림을 보낸지 1시간 이후에 다시 60,000원에 도달하면 푸시 알림을 전송받습니다. 단, 60,000원을 제외한 다른 지정가에 대해서는 푸시 알림을 전송받습니다.
		- 위와 같이 설계한 이유는 종목의 현재가가 계속 변동해서 지정가에 여러번 도달할 가능성이 높기 때문에 많은 푸시 알림을 받을 수 있다고 생각해서입니다.
- 서버는 해당 회원이 설정한 종목의 지정가들중에서 현재가가 종목의 지정가들이 일치하는지 검사하고 일치하는 지정가가 존재한다면 푸시 알림을 전송한다


## 백엔드 내부 서비스

### 클라이언트에게 푸시 알림(Push Notification) 전송
- 백엔드 서버는 회원들의 포트폴리오 및 지정가에 대한 푸시 알림을 보낼 수 있어야 합니다.
- 백엔드 서버가 회원들에게 전송할 알림 종류는 다음과 같습니다.
	- 포트폴리오
		- 목표 수익 금액 달성 알림
		- 최대 손실 금액 도달 알림
	- 종목
		- 회원이 추가한 종목의 지정가 도달 알림
- 포트폴리오 목표수익 금액 달성 알림 조건
	- 포트폴리오의 목표수익 금액 알림이 활성되어야 있어야 합니다.
	- 회원 계정의 목표수익 금액 알림(targetGainNotify)이 활성화 되어 있어야 합니다.
	- 포트폴리오의 현재 잔고(현금) + 포트폴리오 총 손익이 포트폴리오의 목표 수익금액보다 같거나 커야합니다.
		- 현금 + 포트폴리오 총손익 >= 목표수익금액
	- 해당 포트폴리오의 목표 수익금액 달성 알림을 보낸지 24시간이 지나야 합니다. 즉, 전송 이력이 없어야 합니다.
		- 해당 조건을 추가한 이유는 종목의 현재가가 실시간으로 변경되어 위 3개의 알림 전송 조건을 만족하게 되어 다량으로 전송하는 것을 방지하기 위해서입니다.
	- 포트폴리오의 예산이 0원이면 안됩니다.
- 포트폴리오 최대손실 금액 달성 알림 조건
	- 포트폴리오의 최대손실 금액 알림이 활성되어야 있어야 합니다.
	- 회원 계정의 최대손실 금액 알림(maxLossNotify)이 활성화 되어 있어야 합니다.
	- 포트폴리오의 현재 잔고(현금) + 포트폴리오 총 손익이 포트폴리오의 최대손실 금액보다 같거나 작아야합니다.
		- 현금 + 포트폴리오 총손익 <= 최대손실금액
	- 해당 포트폴리오의 최대손실 금액 달성 알림을 보낸지 24시간이 지나야 합니다. 즉, 전송 이력이 없어야 합니다.
		- 위 조건을 추가한 이유도 목표 수익 금액 달성 알림 조건과 동일합니다.
	- 포트폴리오의 예산이 0원이면 안됩니다.
- 회원의 종목 지정가 알림 조건
	- 회원의 종목 지정가 알림이 활성화되어 있어야 합니다.
	- 회원 계정의 종목 지정가 알림(targetPriceNotify)이 활성화 되어 있어야 합니다.
	- 종목의 현재가가 회원이 설정한 종목 지정가와 동일해야 합니다.
	- 종목 지정가 알림 발송 간격은 24시간 이어야 합니다.
- 포트폴리오 목표 수익 금액 달성 알림 이벤트 시점
	- 포트폴리오, 포트폴리오 종목, 포트폴리오 매입 이력과 같은 정보의 변경이 발생할 때마다

### 포트폴리오 목표 수익률 알림 발송
- 서버는 현재가 및 매입 이력 이벤트에 따라서 포트폴리오의 목표 수익률에 도달하면 사용자에게 알림을 전송해야 한다.
- 알림 조건
	- 포트폴리오의 평가 금액이 목표 수익률에 도달
	- 포트폴리오의 목표 수익률 알림 활성화
	- 브라우저 계정 알림 활성화
	- 목표수익률 계정 알림 활성화
	- 특정 포트폴리오의 전송 내역이 존재하지 않음

### FCM 토큰 관리
- 한명의 사용자가 서로 다른 기기로 동일한 계정으로 로그인하는 경우에 푸시 알림을 받게 되면 서로 다른 기기 모두에서 동일한 알림을 받아야 합니다.
	- 한명의 회원은 여러개의 FCM 토큰을 가질 수 있습니다.
- 사용자가 로그인하게 되면 FCM 토큰도 같이 등록되어야 합니다.
- 사용자가 로그아웃하게 되면 FCM 토큰을 삭제하여야 합니다.
- 사용자에게 FCM 토큰을 이용하여 푸시 알림을 보내는 과정에서 푸시 알림 전송에 실패하게 되는 경우 해당 FCM 토큰을 DB에서 제거되어야 합니다.
- 스케줄링 메소드와 같은 기능을 이용하여 주기적으로 토큰들을 검사하여 최근 활성 시간이 2달이 경과된 경우에는 FCM 토큰을 삭제합니다.
