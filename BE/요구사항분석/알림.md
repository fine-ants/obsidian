- [[#백엔드 내부 서비스|백엔드 내부 서비스]]
	- [[#백엔드 내부 서비스#클라이언트에게 푸시 알림(Push Notification) 전송|클라이언트에게 푸시 알림(Push Notification) 전송]]
	- [[#백엔드 내부 서비스#포트폴리오 목표 수익률 알림 발송|포트폴리오 목표 수익률 알림 발송]]
	- [[#백엔드 내부 서비스#종목 지정가 알림 발송|종목 지정가 알림 발송]]
	- [[#백엔드 내부 서비스#FCM 토큰 관리|FCM 토큰 관리]]

## 백엔드 내부 서비스

### 클라이언트에게 푸시 알림(Push Notification) 전송
- 백엔드 서버는 회원들의 포트폴리오 및 지정가에 대한 푸시 알림을 보낼 수 있어야 합니다.
- 백엔드 서버가 회원들에게 전송할 알림 종류는 다음과 같습니다.
	- 포트폴리오
		- 목표 수익 금액 달성 알림
		- 최대 손실 금액 도달 알림
	- 종목
		- 회원이 추가한 종목의 지정가 도달 알림
- 포트폴리오 목표수익 금액 달성 알림 조건
	- 포트폴리오의 목표수익 금액 알림이 활성되어야 있어야 합니다.
	- 회원 계정의 목표수익 금액 알림(targetGainNotify)이 활성화 되어 있어야 합니다.
	- 포트폴리오의 현재 잔고(현금) + 포트폴리오 총 손익이 포트폴리오의 목표 수익금액보다 같거나 커야합니다.
		- 현금 + 포트폴리오 총손익 >= 목표수익금액
	- 해당 포트폴리오의 목표 수익금액 달성 알림을 보낸지 24시간이 지나야 합니다. 즉, 전송 이력이 없어야 합니다.
		- 해당 조건을 추가한 이유는 종목의 현재가가 실시간으로 변경되어 위 3개의 알림 전송 조건을 만족하게 되어 다량으로 전송하는 것을 방지하기 위해서입니다.
	- 포트폴리오의 예산이 0원이면 안됩니다.
- 포트폴리오 최대손실 금액 달성 알림 조건
	- 포트폴리오의 최대손실 금액 알림이 활성되어야 있어야 합니다.
	- 회원 계정의 최대손실 금액 알림(maxLossNotify)이 활성화 되어 있어야 합니다.
	- 포트폴리오의 현재 잔고(현금) + 포트폴리오 총 손익이 포트폴리오의 최대손실 금액보다 같거나 작아야합니다.
		- 현금 + 포트폴리오 총손익 <= 최대손실금액
	- 해당 포트폴리오의 최대손실 금액 달성 알림을 보낸지 24시간이 지나야 합니다. 즉, 전송 이력이 없어야 합니다.
		- 위 조건을 추가한 이유도 목표 수익 금액 달성 알림 조건과 동일합니다.
	- 포트폴리오의 예산이 0원이면 안됩니다.
- 회원의 종목 지정가 알림 조건
	- 회원의 종목 지정가 알림이 활성화되어 있어야 합니다.
	- 회원 계정의 종목 지정가 알림(targetPriceNotify)이 활성화 되어 있어야 합니다.
	- 종목의 현재가가 회원이 설정한 종목 지정가와 동일해야 합니다.
	- 종목 지정가 알림 발송 간격은 24시간 이어야 합니다.
- 포트폴리오 목표 수익 금액 달성 알림 이벤트 시점
	- 포트폴리오, 포트폴리오 종목, 포트폴리오 매입 이력과 같은 정보의 변경이 발생할 때마다

### 포트폴리오 목표 수익률 알림 발송
- 서버는 현재가 및 매입 이력 이벤트에 따라서 포트폴리오의 목표 수익률에 도달하면 사용자에게 알림을 전송해야 한다
- 알림 조건
	- 포트폴리오의 평가 금액이 목표 수익률에 도달
	- 포트폴리오의 목표 수익률 알림 활성화
	- 브라우저 계정 알림 활성화
	- 목표수익률 계정 알림 활성화
	- 특정 포트폴리오의 전송 내역이 존재하지 않음

### 종목 지정가 알림 발송
- 서버는 현재가 이벤트에 따라서 종목 지정가 알림에 도달하면 사용자에게 알림을 전송해야 한다
- 알림 조건
	- 현재가가 종목 지정가 알림의 지정가에 도달
	- 종목 지정가의 알림 활성화
	- 브라우저 계정 알림 활성화
	- 종목 지정가 계정 알림 활성화
	- 특정 종목 지정가의 전송 내역이 존재하지 않음
- 

### FCM 토큰 관리
- 한명의 사용자가 서로 다른 기기로 동일한 계정으로 로그인하는 경우에 푸시 알림을 받게 되면 서로 다른 기기 모두에서 동일한 알림을 받아야 합니다.
	- 한명의 회원은 여러개의 FCM 토큰을 가질 수 있습니다.
- 사용자가 로그인하게 되면 FCM 토큰도 같이 등록되어야 합니다.
- 사용자가 로그아웃하게 되면 FCM 토큰을 삭제하여야 합니다.
- 사용자에게 FCM 토큰을 이용하여 푸시 알림을 보내는 과정에서 푸시 알림 전송에 실패하게 되는 경우 해당 FCM 토큰을 DB에서 제거되어야 합니다.
- 스케줄링 메소드와 같은 기능을 이용하여 주기적으로 토큰들을 검사하여 최근 활성 시간이 2달이 경과된 경우에는 FCM 토큰을 삭제합니다.
