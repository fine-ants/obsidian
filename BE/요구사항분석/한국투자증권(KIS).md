- [[#한국투자증권|한국투자증권]]
	- [[#한국투자증권#종목 현재가 전체 갱신|종목 현재가 전체 갱신]]
	- [[#한국투자증권#종목 현재가 일부 갱신|종목 현재가 일부 갱신]]
	- [[#한국투자증권#종목 현재가 조회|종목 현재가 조회]]
	- [[#한국투자증권#종목 종가 전체 갱신|종목 종가 전체 갱신]]
	- [[#한국투자증권#종목 종가 일부 갱신|종목 종가 일부 갱신]]


## 한국투자증권
### 종목 현재가 전체 갱신
- 관리자는 서버에서 관리하고 있는 종목의 현재가를 다시 갱신합니다.
- 응답정보
	- 티커심볼(tickerSymbol)
	- 현재가(price)

### 종목 현재가 일부 갱신
- 관리자는 일부 종목들의 현재가를 갱신합니다.
- 입력 정보
	- 티커심볼 리스트(tickerSymbols)
- 응답 정보
	- 티커심볼(tickerSymbol)
	- 현재가(price)

### 종목 현재가 조회
- 관리자는 한국투자증권 외부 서버를 통하여 종목의 현재가를 조회합니다.
- 응답 정보
	- 티커심볼(tickerSymbol)
	- 현재가(price)

### 종목 종가 전체 갱신
- 관리자는 한국투자증권 외부 서버를 통하여 서버에서 관리하고 있는 전체 종목들의 종가를 다시 갱신합니다.
- 응답정보
	- 티커심볼(tickerSymbol)
	- 종가(closingPrice)

### 종목 종가 일부 갱신
- 관리자는 한국투자증권 외부 서버를 통하여 일부 종목들의 종가를 갱신합니다.
- 입력 정보
	- 티커심볼 리스트(tickerSymbols)
- 응답 정보
	- 티커심볼(tickerSymbol)
	- 종가(closingPrice)

### 종목 상장 정보 조회
- 한국투자증권 외부 서버를 통하여 종목의 상장 정보를 조회합니다.


## 종목 현재가 갱신 시스템 개선

현재 서버에서 종목의 현재가를 갱신하는 방법은 장 시간(9~16)동안에 포트폴리오들에 저장된 종목들을 대상으로 각각 한국투자증권에 질의한 다음에 질의한 현재가를 레디스 저장소에 저장하는 방식입니다. 실행 과정을 정리하면 다음과 같습니다.
1. 장시간에 모든 포트폴리오 및 종목 지정가를 조회합니다.
2. 포트폴리오에 저장된 모든 종목들을 조회합니다.
3. 고유한 모든 종목들의 티커심볼을 이용하여 한국투자증권에 질의합니다.
4. 질의한 결과에서 현재가를 레디스 저장소에 저장합니다.

위와 같은 시스템에서 문제점은 포트폴리오에 등록된 종목만을 대상으로 각각의 종목들에 대해서 현재가 조회를 질의한다는 점입니다. 사용자는 요청하지도 않았지만 계속 현재가를 조회한 다음에 레디스에 저장해두고 있습니다. 또한 각각의 종목에 대해서 한국투자증권에 REST API 요청을 하기 때문에 많은 요청을 하는 점도 있습니다. 문제점을 정리하면 다음과 같습니다.
- 사용자가 실제 요청하지도 않는 종목에 대해서 현재가 갱신
- 한국투자증권에 많은 REST API 요청을 하고 있음

현재 시스템에서는 사용자가 포트폴리오 종목 조회로 인하여 SSE 방식으로 응답하여도 종목의 현재가 갱신과는 관계없이 레디스에 저장된 현재가를 가져와서 응답합니다. 

### 개선방향
사용자가 특정한 포트폴리오를 조회할때 서버에서는 SSE 방식으로 데이터를 응답하게 됩니다. 따라서 특정한 포트폴리오 조회시 포트폴리오에 등록된 종목들을 가지고 종목들만을 관리하는 모듈에 넣습니다. 관리하는 모듈은 현재가 관리하고 있는 종목들을 이용하여 한국투자증권의 실시간 종목 체결가 API와 웹소켓 연결을 하여 실시간 체결가에 따른 현재가를 받습니다. 현재가를 받으면 레디스 저장소에 넣습니다. 그리고 사용자가 SSE 조회를 마치면 관리하는 모듈에서 종목을 제거하여 웹소켓 연결을 끊습니다. 


종목의 현재가 갱신 과정은 다음과 같습니다.
1. 사용자는 SSE 통신 방식으로 수행되는 포트폴리오 종목 조회 API 요청합니다.
2. 서버는 API를 받으면 사용자의 포트폴리오에 등록된 종목들의 티커 심볼을 어떤 저장소(StockPriceRepository)에 푸시하여 관리하도록 합니다.
3. 어떤 한 컴포넌트(이름 미정)는 StockPriceRepository에 저장된 티커 심볼들을 기반으로 한국투자증권의 종목 실시간 체결가 웹소켓 연결에 메시지를 전송합니다. (티커 심볼 전송)
  - 한국투자증권 서버와의 웹소켓 연결은 서버 실행시 이루어집니다.
4. 한국투자증권은 웹소켓 연결되어 있는 상태에서 티커 심볼을 받으면 종목의 실시간 체결가를 계속 응답해줍니다.
5. 응답을 받은 스프링 클라이언트는 파싱한 다음에 레디스 저장소에 종목에 대한 현재가를 저장합니다.
6. 포트폴리오 종목 조회 API를 받은 서버는 3~5번 과정과는 별도로 레디스에 저장된 현재가를 참조하여 사용자에게 포트폴리오의 계산 정보를 SSE 응답합니다.

완성된 시스템 설계는 다음과 같습니다.
![[Pasted image 20240911103846.png]]

### 웹소켓 연결 제약사항
- 한국투자증권 서버와 웹소켓 연결한 다음에 수신되는 체결가, 호가, 통보 등 데이터가 100초 이상 없는 경우 세션이 자동 종료됩니다.
- 세션 자동 종료를 방지하기 위해서 수신 시에 퐁 데이터를 발신해야 합니다.
	- input
		- tr_id (String)
		- datetime (String)
			- 예시 : 20211101180010
	- output
		- tr_id
		- datetime
- 백엔드 서버에서는 한국투자증권 서버로부터 핑퐁 데이터를 수신시에 퐁 데이터를 발신해야 합니다.
