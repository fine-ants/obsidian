- [[#한국투자증권|한국투자증권]]
	- [[#한국투자증권#종목 현재가 전체 갱신|종목 현재가 전체 갱신]]
	- [[#한국투자증권#종목 현재가 일부 갱신|종목 현재가 일부 갱신]]
	- [[#한국투자증권#종목 현재가 조회|종목 현재가 조회]]
	- [[#한국투자증권#종목 종가 전체 갱신|종목 종가 전체 갱신]]
	- [[#한국투자증권#종목 종가 일부 갱신|종목 종가 일부 갱신]]


## 한국투자증권
### 종목 현재가 전체 갱신
- 관리자는 서버에서 관리하고 있는 종목의 현재가를 다시 갱신합니다.
- 응답정보
	- 티커심볼(tickerSymbol)
	- 현재가(price)

### 종목 현재가 일부 갱신
- 관리자는 일부 종목들의 현재가를 갱신합니다.
- 입력 정보
	- 티커심볼 리스트(tickerSymbols)
- 응답 정보
	- 티커심볼(tickerSymbol)
	- 현재가(price)

### 종목 현재가 조회
- 관리자는 한국투자증권 외부 서버를 통하여 종목의 현재가를 조회합니다.
- 응답 정보
	- 티커심볼(tickerSymbol)
	- 현재가(price)

### 종목 종가 전체 갱신
- 관리자는 한국투자증권 외부 서버를 통하여 서버에서 관리하고 있는 전체 종목들의 종가를 다시 갱신합니다.
- 응답정보
	- 티커심볼(tickerSymbol)
	- 종가(closingPrice)

### 종목 종가 일부 갱신
- 관리자는 한국투자증권 외부 서버를 통하여 일부 종목들의 종가를 갱신합니다.
- 입력 정보
	- 티커심볼 리스트(tickerSymbols)
- 응답 정보
	- 티커심볼(tickerSymbol)
	- 종가(closingPrice)

### 종목 상장 정보 조회
- 한국투자증권 외부 서버를 통하여 종목의 상장 정보를 조회합니다.


## 종목 현재가 갱신 시스템 개선

현재 서버에서 종목의 현재가를 갱신하는 방법은 장 시간(9~16)동안에 포트폴리오들에 저장된 종목들을 대상으로 각각 한국투자증권에 질의한 다음에 질의한 현재가를 레디스 저장소에 저장하는 방식입니다. 실행 과정을 정리하면 다음과 같습니다.
1. 장시간에 모든 포트폴리오 및 종목 지정가를 조회합니다.
2. 포트폴리오에 저장된 모든 종목들을 조회합니다.
3. 고유한 모든 종목들의 티커심볼을 이용하여 한국투자증권에 질의합니다.
4. 질의한 결과에서 현재가를 레디스 저장소에 저장합니다.

위와 같은 시스템에서 문제점은 포트폴리오에 등록된 종목만을 대상으로 각각의 종목들에 대해서 현재가 조회를 질의한다는 점입니다. 사용자는 요청하지도 않았지만 계속 현재가를 조회한 다음에 레디스에 저장해두고 있습니다. 또한 각각의 종목에 대해서 한국투자증권에 REST API 요청을 하기 때문에 많은 요청을 하는 점도 있습니다. 문제점을 정리하면 다음과 같습니다.
- 사용자가 실제 요청하지도 않는 종목에 대해서 현재가 갱신
- 한국투자증권에 많은 REST API 요청을 하고 있음

현재 시스템에서는 사용자가 포트폴리오 종목 조회로 인하여 SSE 방식으로 응답하여도 종목의 현재가 갱신과는 관계없이 레디스에 저장된 현재가를 가져와서 응답합니다. 

### 개선방향
사용자가 특정한 포트폴리오를 조회할때 서버에서는 SSE 방식으로 데이터를 응답하게 됩니다. 따라서 특정한 포트폴리오 조회시 포트폴리오에 등록된 종목들을 가지고 종목들만을 관리하는 모듈에 넣습니다. 관리하는 모듈은 현재가 관리하고 있는 종목들을 이용하여 한국투자증권의 실시간 종목 체결가 API와 웹소켓 연결을 하여 실시간 체결가에 따른 현재가를 받습니다. 현재가를 받으면 레디스 저장소에 넣습니다. 그리고 사용자가 SSE 조회를 마치면 관리하는 모듈에서 종목을 제거하여 웹소켓 연결을 끊습니다. 


종목의 현재가 갱신 과정은 다음과 같습니다.
1. 사용자는 SSE 통신 방식으로 수행되는 포트폴리오 종목 조회 API 요청합니다.
2. 서버는 API를 받으면 사용자의 포트폴리오에 등록된 종목들의 티커 심볼을 어떤 저장소(StockPriceRepository)에 푸시하여 관리하도록 합니다.
3. 어떤 한 컴포넌트(이름 미정)는 StockPriceRepository에 저장된 티커 심볼들을 기반으로 한국투자증권의 종목 실시간 체결가 웹소켓 연결에 메시지를 전송합니다. (티커 심볼 전송)
  - 한국투자증권 서버와의 웹소켓 연결은 서버 실행시 이루어집니다.
4. 한국투자증권은 웹소켓 연결되어 있는 상태에서 티커 심볼을 받으면 종목의 실시간 체결가를 계속 응답해줍니다.
5. 응답을 받은 스프링 클라이언트는 파싱한 다음에 레디스 저장소에 종목에 대한 현재가를 저장합니다.
6. 포트폴리오 종목 조회 API를 받은 서버는 3~5번 과정과는 별도로 레디스에 저장된 현재가를 참조하여 사용자에게 포트폴리오의 계산 정보를 SSE 응답합니다.

완성된 시스템 설계는 다음과 같습니다.
![[Pasted image 20240911103846.png]]

### 웹소켓 연결 제약사항
- 한국투자증권 서버와 웹소켓 연결한 다음에 수신되는 체결가, 호가, 통보 등 데이터가 100초 이상 없는 경우 세션이 자동 종료됩니다.
- 세션 자동 종료를 방지하기 위해서 수신 시에 퐁 데이터를 발신해야 합니다.
	- 퐁 데이터를 발신하기 위해서는 받은 메시지 그대로 세션을 통해서 메시지 전송하면 됩니다.

### 종목 실시간 체결가의 수신 메시지 처리
#### 배경
- 한국투자증권 웹소켓 서버와 연결되면 다양한 수신 메시지를 받게 됩니다. 가장 일반적인 수신 메시지는 종목의 실시간 체결이지만 특정한 상황에서 에러 메시지를 수신받을 수 있습니다.
- 예를 들어 포트폴리오에 등록된 종목이 20개가 넘는 경우에 한국투자증권 서버로부터 실시간 체결가를 받을 수 있는 종목의 구독 초과했다는 메시지를 받습니다. 응답 내용은 다음과 같습니다.
```json
{
  "header": {
    "tr_id": "H0STCNT0",
    "tr_key": "091580",
    "encrypt": "N"
  },
  "body": {
    "rt_cd": "1",
    "msg_cd": "OPSP0008",
    "msg1": "MAX SUBSCRIBE OVER"
  }
}
```

#### 제약조건
- 종목 실시간 체결가 저장소에 20개가 넘는 종목들을 저장해서는 안됩니다.
	- 한국투자증권 웹소켓 서버와 종목 실시간 체결가를 구독할 수 있는 종목의 개수가 최대 20개이기 때문입니다.

#### 처리
- 종목 실시간 체결가의 최대 구독 초과 처리의 과정은 다음과 같습니다.
	1. 사용자는 실시간 포트폴리오 종목 조회를 요청한다.
		- 이때 사용자의 포트폴리오에는 100개의 종목이 들어있다고 가정합니다.
	2. 포트폴리오의 종목 100개를 종목 실시간 체결가 저장소에 저장합니다.
		- 만약 종목 실시간 체결가 저장소에 종목을 저장하다가 현재 개수가 20개 미만이면 저장하고, 20개 이상이면 더이상 저장하지 않습니다.
	3. 종목 실시간 체결가 저장소에 저장된 종목들은 StockPriceDispatcher에 의해서 StockPriceWebSocketClient에 종목 실시간 체결가 구독을 요청합니다.
	4. StockPriceWebSocketClient는 세션을 통해서 구독을 요청합니다.
		- 세션을 통해서 메시지 전송시 파이프가 부러지는 (broken pipe) 예외가 발생하면 세션을 종료하고 재연결 한다.
	5. 구독에 성공하면 핸들러에 의해서 메시지를 받게 되어 적절한 처리를 합니다.
		- 구독 성공하는 경우 : 리스폰스 객체로 파싱한 다음에 로깅
		- 실시간 체결가 메시지를 수신하는 경우 : 종목의 현재가를 레디스에 저장한다
		- 핑퐁 메시지를 수신하는 경우 : 해당 경우는 종목의 실시간 체결가가 없는 경우 한국투자증권 웹소켓 서버로부터 주기적으로 핑퐁 메시지를 전송하여 클라이언트가 연결되어 있는지 확인하는 용도의 메시지입니다. 해당 핑퐁 메시지를 받는 경우 받은 메시지 그대로 퐁 데이터를 발신합니다.
			- 퐁 데이터 메시지 전송시 파이프가 부러지는 (broken pipe) 예외가 발생하면 세션을 종료하고 재연결한다
		- 구독 최대 초과 메시지를 수신하는 경우 : 종목 실시간 체결가 저장소에서 최근에 넣은 종목을 제거한다.
		- 구독 내부 에러를 수신하는 경우 및 그외의 경우 : 메시지 로깅 및 별도 처리 없음 (미정)
	6. 종목 실시간 체결가 저장소에 저장되지 않은 종목들에 대해서는 REST API 방식을 이용하여 종목의 현재가를 조회한 다음에 현재가를 레디스에 저장합니다.
		- 종목의 현재가 조회를 특정 횟수 시도후에도 실패하면 현재가를 저장하지 않는다. 클라이언트에서는 캐시된 현재가를 응답한다.
- 클라이언트가 더이상 종목의 현재가를 조회할 이유가 없다면 FIneAnts 서버에서는 한국투자증권 웹소켓 서버와의 관계에서 해당 종목의 구독을 해제해야 합니다.
	- 예를 들어 여러 클라이언트들 사이에서 한명이라도 삼성전자 종목을 더이상 실시간 조회하고 있지 않는다면 FineAnts 서버는 해당 종목에 대해서 구독 해제합니다.

#### 메모
- 하나의 포트폴리오에 20개가 넘는 100개의 종목이 있는 경우 가격을 어떻게 갱신해야 하는가? 한국투자증권 웹소켓 서버에 등록할 수 있는 종목은 최대 20개이기 때문에 나머지 80개의 종목에 대해서 실시간 체결가를 받을 수 없습니다.
	- 구독을 못한 나머지 종목에 대해서는 REST API 방식으로 현재가를 조회하여 레디스에 저장한다
- 또한 구독 초과가 발생하여 우선순위가 낮은 종목을 제거하고 다른 종목에 대하여 구독을 하여도 나머지 80개의 종목에 대해서도 별반 차이가 없는 문제가 있다. 결국 나머지 80개의 대헤서는 실시간 체결가를 받지 못한다!!
	- 구독 초과가 발생하면 더이상 종목을 넣지 않는다.
- 다른 포트폴리오의 종목까지 포함하여 구독한 종목의 개수가 20개가 차있는 경우 어떻게 종목의 실시간 현재가를 갱신하는가?
	- 저장소에 넣지 않고 REST API 방식으로 현재가를 조회하여 레디스에 저장한다
- 해결해야할 에러 종류
	- max subscribe over
		- 종목 실시간 체결가 저장소에서 가장 최근에 넣은 종목을 제거한다
	- subscribe internal error
		- 아직 미정. 일단은 에러 메시질를 로깅 처리함.
	- broken pipe
		- 세션을 종료하고 재연결을 수행합니다. 그리고 현재 저장되어 있는 종목들에 대하여 구독 설정함
	- text_partial_warnings
		- 메시지 분석후 에러 해들링 처리가 필요함
- 구독을 못한 종목에 대해서는 REST API 방식으로 처리하기로 하였는데 장시간에는 지속적으로 조회한 다음에 저장해야 할 것이다. 어떻게 관리해야 할까?
	- 지속적으로 현재가를 조회할 종목들을 어느 하나의 저장소에 저장해 두었다가 스케줄러와 같은 방법을 통해서 지속적으로 조회한 다음에 레디스에 저장한다
	- 사용자가 실시간 포트폴리오 종목 조회시 해당 종목들에 대하여 카운팅을 1개씩 올린다.
		- 카운팅을 내릴때는 어떻게 내려야 하는가?