
## Grafana Loki란 무엇인가?
Grafana Loki는 Prometheus에서 영감을 받은 로그 집계 시스템으로, 로깅 및 이벤트 데이터를 수집하고, 저장하고 검색하기 위한 오픈소스 플랫폼입니다.

Loki는 로그 전체 텍스트가 아닌 메타데이터(metadata)만 인덱싱(Indexing)하는 방식을 취합니다. 다음 그림을 보면 Timestamp와 Label 부분만 인덱싱하는 작업을 수행하고, 로깅의 내용 부분은 인덱싱하지 않습니다. 
![[Pasted image 20250210140630.png]]

#### Loki가 메타데이터만 인덱싱하는 이유
Loki가 로그 전체 텍스트가 아닌 메타 데이터만 인덱싱하는 방식을 취하는 이유는 다음과 같습니다.
- 인덱스 크기 최소화
	- 로그 데이터를 완전히 인덱싱하려면 로그 전체 텍스트를 저장해야 하는데, 이는 매우 많은 저장 공간이 필요합니다.
	- 로그 텍스트가 길면 길수록 비효율적이고 비용이 많이 소요됩니다.
	- 대신에 메타 데이터(로그 레벨, 서비스 이름, 파일 이름, 타임스탬프, 라벨 등)만 인덱싱하면 **인덱스 크기가 줄어들어서 빠르게 조회할 수 있고, 저장 비용도 감소**합니다.
- 빠른 검색 및 쿼리 성능 향상
	- Loki는 시간 기반의 로그 쿼리를 자주 실행합니다. 예를 들어, 특정 시간 범위 이내의 로그를 검색하는 경우, 메타 데이터를 인덱싱함으로써 쿼리를 효율적으로 처리할 수 있습니다.
	- 예를 들어 job, instance, level, filename과 같은 메타 데이터를 기준으로 로그를 빠르게 필터링할 수 있습니다.
- 저장 비용 절감
	- 로그 전체 텍스트를 저장하면 저장 비용이 증가됩니다. 하지만 메타 데이터만 인덱싱하면 데이터 크기를 줄일수 있습니다. 이는 비용 절감으로 이어집니다.
	- 실제 로그 메시지 본문은 청크(chunk) 데이터 단위로 저장되며, 검색 시에는 메타 데이터만 참조하여 필요한 데이터를 빠르게 찾습니다. 로그 메시지 본문은 필요할때만 불러오고 검색 효율성을 증가시킵니다.
- 확장성
	- 로그의 양이 급증할 수 있는 환경에서 메타 데이터만 인덱싱하는 방식은 **시스템의 확장성을 높여줍니다.**
	- 전체 로그 텍스트를 인덱싱하면 시스템이 성능 문제를 일으킬 수 있지만, 메타 데이터만 인덱싱하면 더 많은 데이터를 처리할 수 있습니다.

Grafana Loki는 다음과 같이 작동합니다.
![[Pasted image 20250210143724.png]]
Loki를 위해 만들어진 로그 수집 도구인 Promtail을 통해서 로그를 수집하고 Loki에 저장합니다. 이후 Grafana에서 LogQL이라는 쿼리 언어를 통해서 로그를 검색합니다. 또한 경고 규칙을 설정하여 Prometheus AlertManager로 경고를 보낼수 있습니다.

다음은 Grafana Loki의 주요 구성 요소입니다.
![[Pasted image 20250210144024.png]]
다음은 Grafana Loki 주요 구성 요소의 설명입니다.
- Distributor
	- 클라이언트로부터 수신한 로그 데이터를 검증 후에 Ingester에게 전달하는 역할을 수행합니다.
- Ingester
	- Distributor로부터 받은 로그 데이터를 메모리에 압축하여 chunks 단위로 저장하고, 일정 시간 후에 장기 저장소(DynamoDB, S3, Cassandra 등)에 기록합니다.
- Querier
	- Ingester의 인메모리(in-memory) 데이터를 쿼리한 후에 장기 저장소(S3)에서 쿼리 로그를 가져와 Query-Frontend에게 데이터를 반환합니다. Ingester에서 복제 데이터를 가져올수 있기 때문에 내부적으로 중복을 제거합니다.
- Query-Frontend
	- 실제 쿼리 실행에 필요한 Querier의 역할을 보조하며 읽기 경로를 가속화합니다. Query Frontend는 내부적으로 쿼리를 조정하고 큐에 보관합니다.
- Compactor
	- chunk 보관 주기를 관리하고(retention), 테이블을 단일 인덱스 파일로 압축합니다.
	- Compactor를 통한 보존은 boltdb-shipper 또는 tsdb store에서만 지원됩니다.
		- Loki 2.8 부터는 tsdb store 사용 권장, boltdb-shipper보다 효율적이고 빠르며 확장이 뛰어납니다.
- Ruler
	- 사용자가 정의한 경고 규칙 기반으로 경고를 발생시키는 등 로그 데이터에 관한 경고를 관리합니다.

#### 데이터 읽기/쓰기 흐름 과정
**읽기 흐름 과정**
1. Read 요청할때 Querier에서 해당 요청을 수신합니다.
2. Querier는 Ingester의 인메모리(in-memory)를 조회합니다.
3. Ingester에서 캐시된 데이터가 있는 경우 Querier에게 반환하고, 캐시된 데이터가 없다면 장기 저장소(S3)에서 데이터를 조회합니다.
4. Querier는 

