## 성능 테스트 시나리오: 비동기 갱신 최적화 검증

### 1. 테스트 환경 및 조건

- **대상 장비:** Mac os (8 vCPU, 16GB RAM)
- **가상 사용자 (VU):** 500명 (동시 접속자)
- **테스트 지속 시간:** 10분 (부하 누적 관찰)
- **데이터 셋업:** * Redis에 총 **50개 종목**의 시세 데이터 미리 적재.
    - 모든 데이터의 타임스탬프를 **현재 시간 기준 -10분**으로 설정 (신선도 5초 초과 → Stale 상태 강제).
- **시간 설정:** 서버 로직 상 **'장시간 외(Closed Market)'**로 판정되는 시간대 설정.
    
---

### 2. 시나리오 상세 루프 (User Flow)
각 가상 사용자는 아래 동작을 반복합니다.
1. **로그인:** 테스트 회원 계정으로 인증 (JWT 등 발급).
2. **종목 조회:** 준비된 50개 종목 리스트 중 무작위로 **5개 종목**을 선정하여 현재가 조회 API 호출.
3. **대기 (Think Time):** 1초~2초간 대기 후 다시 다른 종목 조회 반복.
    
---

### 3. 대조군 vs 실험군 설정

#### **[Scenario A] 기존 시스템 (개선 전)**
- **기대 동작:** 1. 유저가 시세를 요청하면 Redis에서 Stale 데이터를 꺼내 반환함. 2. 동시에 **비동기 이벤트가 발행**되어 외부 KIS API 호출 스레드가 생성됨.
- **예상 병목:** 50명이 계속 요청할 경우 초당 수십 개의 비동기 스레드가 생성되어 CPU 점유율이 급증하고, 외부 API 타임아웃(Handshake error)이 발생함.
    

#### **[Scenario B] 개선 시스템 (개선 후)**
- **기대 동작:** 1. 유저가 시세를 요청하면 Redis에서 Stale 데이터를 꺼내 반환함. 2. **장시간 외임을 판별하여 이벤트를 발행하지 않음.** (핵심 차단 로직)
- **예상 결과:** 비동기 스레드 생성이 0에 수렴하며, 단순 조회만 수행하므로 CPU 및 메모리 사용량이 매우 낮고 안정적으로 유지됨.


### 4. 수집 및 비교 지표 (Key Results)
| **비교 항목**               | **측정 도구**       | **목적**                     |
| ----------------------- | --------------- | -------------------------- |
| **P99 응답 속도**           | JMeter          | 부하 시 응답의 최대 지연 시간 확인       |
| **CPU Usage (%)**       | VisualVM        | 불필요한 스레드 생성에 따른 연산 부하 비교   |
| **Active Thread Count** | Spring Actuator | 비동기 작업 스레드가 과도하게 생성되는지 감시  |
| **External API Call**   | App Log         | 실제 외부 통신이 차단되었는지(0건) 최종 확인 |

## 성능 테스트 결과

### 시나리오 A
- P99 응답 속도
- CPU Usage (%)
- Active Thread Count
- External API Call
